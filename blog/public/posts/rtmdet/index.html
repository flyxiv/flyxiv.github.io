<!DOCTYPE html>
<html lang="en-us"
  x-data
  :class="$store.darkMode.class()"
  :data-theme="$store.darkMode.theme()">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&lt;Computer Vision&gt; Implementing RTMDet-Ins 1. Backbone/Neck/Head Implementation | Junyeop Na Dev</title>

    

<link rel="canonical" href="http://example.org/posts/rtmdet/" />



<meta name="author" content="Jun Yeop(Johnny) Na" />
<meta name="description" content="Implementing Instance Segmentation Model From Basic Pytorch: Segformer I&amp;rsquo;m currently working on a pixel sprite detection pipeline called nino:
For the segmentation model, I chose to implement RTMDet-Ins, because
I haven&amp;rsquo;t used this model before, so it will be a good chance to learn about it It is the current SOTA model for instance segmentation in real time. 0. Overview paper linkNeed custom CSP backbone blocks PAFPN Heads for various tasks seems simple." />


<meta name="keywords" content="deep learning,machine learning,pytorch,segformer,computer vision,image segmentation">



<meta name="generator" content="Hugo 0.115.4">


<meta property="og:title" content="&lt;Computer Vision&gt; Implementing RTMDet-Ins 1. Backbone/Neck/Head Implementation" />
<meta property="og:description" content="Implementing Instance Segmentation Model From Basic Pytorch: Segformer I&rsquo;m currently working on a pixel sprite detection pipeline called nino:
For the segmentation model, I chose to implement RTMDet-Ins, because
I haven&rsquo;t used this model before, so it will be a good chance to learn about it It is the current SOTA model for instance segmentation in real time. 0. Overview paper linkNeed custom CSP backbone blocks PAFPN Heads for various tasks seems simple." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/rtmdet/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-03-30T08:47:20+00:00" />
<meta property="article:modified_time" content="2025-03-30T08:47:20+00:00" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="&lt;Computer Vision&gt; Implementing RTMDet-Ins 1. Backbone/Neck/Head Implementation"/>
<meta name="twitter:description" content="Implementing Instance Segmentation Model From Basic Pytorch: Segformer I&rsquo;m currently working on a pixel sprite detection pipeline called nino:
For the segmentation model, I chose to implement RTMDet-Ins, because
I haven&rsquo;t used this model before, so it will be a good chance to learn about it It is the current SOTA model for instance segmentation in real time. 0. Overview paper linkNeed custom CSP backbone blocks PAFPN Heads for various tasks seems simple."/>




  

<link rel="stylesheet" href="/css/output.min.css" />




    


<style>
  pre {
    padding: 1em;
    overflow: auto;
  }
</style>









    

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>

  <body x-data="{
    flip: false,
  }">
    
    <div id="dream-global-bg"></div>

    
<nav class="mt-4 lg:mt-8 py-4">

  
  <div class="container flex justify-between px-4">
  
    <section class="flex items-center gap-4">
      <div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title="Flip it!">
        <div class="h-10 rounded-full">
          <img src="/" alt="" />
        </div>
      </div>

      
    </section>

    <div class="dropdown dropdown-end sm:hidden">
      <div tabindex="0" role="button" class="btn btn-ghost btn-square" aria-label="Select an option">
        <ion-icon name="menu" class="text-2xl"></ion-icon>
      </div>
      <ul tabindex="0" class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md">
        

















<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/posts" title="Archives">
    <ion-icon name="archive"></ion-icon>
    Archives
  </a>
</li>




<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/categories" title="All Categories">
    <ion-icon name="grid"></ion-icon>
    All Categories
  </a>
</li>




<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/tags" title="All Tags">
    <ion-icon name="pricetags"></ion-icon>
    All Tags
  </a>
</li>






      </ul>
    </div>
    <section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4">
      
      

      

      
      





      
      





      
      





      
      
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/posts" title="Archives">
  <ion-icon class="group-hover:text-primary-content" name="archive"></ion-icon>
</a>


      
      
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/categories" title="All Categories">
  <ion-icon class="group-hover:text-primary-content" name="grid"></ion-icon>
</a>


      
      
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/tags" title="All Tags">
  <ion-icon class="group-hover:text-primary-content" name="pricetags"></ion-icon>
</a>


      

      

      
    </section>
  </div>
</nav>


    <div class="flip-container" :class="{ 'flip-it': flip }">
      <div class="flipper">
        <div class="front">
          <div class="container">
            
<div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4">
  <div class="hidden lg:block">
    
  </div>

  <div class="lg:col-span-2">
    <article class="mx-auto prose prose-quoteless dark:prose-invert" id="dream-single-post-main" itemscope itemtype="http://schema.org/Article">
      <meta itemprop="name" content="&lt;Computer Vision&gt; Implementing RTMDet-Ins 1. Backbone/Neck/Head Implementation">
<meta itemprop="description" content="Implementing Instance Segmentation Model From Basic Pytorch: Segformer I&rsquo;m currently working on a pixel sprite detection pipeline called nino:
For the segmentation model, I chose to implement RTMDet-Ins, because
I haven&rsquo;t used this model before, so it will be a good chance to learn about it It is the current SOTA model for instance segmentation in real time. 0. Overview paper linkNeed custom CSP backbone blocks PAFPN Heads for various tasks seems simple."><meta itemprop="datePublished" content="2025-03-30T08:47:20+00:00" />
<meta itemprop="dateModified" content="2025-03-30T08:47:20+00:00" />
<meta itemprop="wordCount" content="1243">
<meta itemprop="keywords" content="deep learning,machine learning,pytorch,segformer,computer vision,image segmentation," />

      <header>
        <h1 itemprop="headline">&lt;Computer Vision&gt; Implementing RTMDet-Ins 1. Backbone/Neck/Head Implementation</h1>
        <p class="text-sm">
          
            Sunday, Mar 30, 2025
          

          | <span>6 minute read</span>

          
          | <span>Updated at
            
              Sunday, Mar 30, 2025
            </span>
          
        </p>

        
        <div class="flex justify-between">
          
            <div class="flex items-center">
  
  <span>@</span>
  

  <span itemprop="author" itemscope itemtype="https://schema.org/Person">
  
    
      <span itemprop="name">Jun Yeop(Johnny) Na</span>
    
  
  </span>
</div>

          

          <div class="flex items-center gap-2">
  
  

  
  
  
  
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="https://x.com/intent/post?text=%3cComputer%20Vision%3e%20Implementing%20RTMDet-Ins%201.%20Backbone/Neck/Head%20Implementation&amp;url=http://example.org/posts/rtmdet/" target="_blank" rel="noopener noreferrer"
      title="Share on X">
      <ion-icon class="group-hover:text-primary-content" name="logo-x"></ion-icon>
    </a>
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="https://facebook.com/sharer/sharer.php?u=http://example.org/posts/rtmdet/" target="_blank" rel="noopener noreferrer"
      title="Share on Facebook">
      <ion-icon class="group-hover:text-primary-content" name="logo-facebook"></ion-icon>
    </a>
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="https://wa.me/?text=%3cComputer%20Vision%3e%20Implementing%20RTMDet-Ins%201.%20Backbone/Neck/Head%20Implementation%20http://example.org/posts/rtmdet/" target="_blank" rel="noopener noreferrer"
      title="Share on WhatsApp">
      <ion-icon class="group-hover:text-primary-content" name="logo-whatsapp"></ion-icon>
    </a>
  

  
  
</div>

        </div>
      </header>

      <section id="dream-single-post-content" itemprop="articleBody">
        

        <h1 id="implementing-instance-segmentation-model-from-basic-pytorch-segformer">Implementing Instance Segmentation Model From Basic Pytorch: Segformer</h1>
<p>I&rsquo;m currently working on a pixel sprite detection pipeline called <a href="https://github.com/flyxiv/nino" target="_blank">nino</a>
:</p>
<p><img src="./nino.png" alt="nino"></p>
<p>For the segmentation model, I chose to implement <code>RTMDet-Ins</code>, because</p>
<ol>
<li>I haven&rsquo;t used this model before, so it will be a good chance to learn about it</li>
<li>It is the current SOTA model for instance segmentation in real time.</li>
</ol>
<h2 id="0-overview">0. Overview</h2>
<ul>
<li><a href="https://arxiv.org/pdf/2212.07784" target="_blank">paper link</a>
</li>
</ul>
<p><img src="./rtmdet.png" alt="rtmdet"></p>
<ol>
<li>Need custom CSP backbone blocks</li>
<li>PAFPN</li>
<li>Heads for various tasks</li>
</ol>
<p>seems simple.</p>
<h2 id="1-implement-custom-csp">1. Implement Custom CSP</h2>
<p>RTMDet uses <strong>5x5 conv layer bottleneck blocks like the below image&rsquo;s figure 3.b:</strong></p>
<p><img src="./rtmdet2.png" alt="block"></p>
<p>The CSP layer puts input through a 1x1 or 3x3 with 2 stride CNN layer depending on whether to downsampling or not.
All can be easily implemented by torch components.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RTMDetBottleneck</span>(nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;RTMDet Bottleneck Block Layer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Uses 5x5 depthwise Convolution layer and a Pointwise 1x1 Convolution layer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Preserves
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, in_channels):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>in_channels <span style="color:#f92672">=</span> in_channels
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>out_channels <span style="color:#f92672">=</span> in_channels
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>in_channels, self<span style="color:#f92672">.</span>out_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>batch_norm1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>out_channels)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>silu <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>SiLU()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># groups=self.out_channels for depthwise convolution</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>out_channels, self<span style="color:#f92672">.</span>out_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, groups<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>out_channels, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>out_channels, self<span style="color:#f92672">.</span>out_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>batch_norm2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>out_channels)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(x)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>batch_norm1(x)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>silu(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv2(x)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>batch_norm2(x)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>silu(x)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RTMDetCSPBlock</span>(nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;RTMDet CSP Block Layer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Uses rtmdet bottleneck layer.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Input:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        x: torch.Tensor, shape: (B, C, H, W)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Output:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        x: torch.Tensor, shape: (B, C&#39;, H&#39;, W&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, in_channels, out_channels, downsample<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>in_channels <span style="color:#f92672">=</span> in_channels
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>out_channels <span style="color:#f92672">=</span> out_channels
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> downsample:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>conv <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>in_channels, self<span style="color:#f92672">.</span>in_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>conv <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>in_channels, self<span style="color:#f92672">.</span>in_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bottleneck <span style="color:#f92672">=</span> RTMDetBottleneck(in_channels<span style="color:#f92672">=</span>in_channels)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>merge_conv <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>in_channels <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, self<span style="color:#f92672">.</span>out_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv(x)
</span></span><span style="display:flex;"><span>        x_bottleneck <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>bottleneck(x)
</span></span><span style="display:flex;"><span>        x_concat <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([x, x_bottleneck], dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        x_merged <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>merge_conv(x_concat)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> x_merged
</span></span></code></pre></div><h1 id="2-pafpn">2. PAFPN</h1>
<p><img src="./rtmdet3.png" alt="pafpn"></p>
<p>Paper doesn&rsquo;t explain in detail. <strong>Resize is probably interpolation/downsampling into CSP Block.</strong>
PAFPN upsampling isn&rsquo;t done using transpose CNN layers. Instead we use manual upsample function from Pytorch.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Implementation of the RTMDet PAFPN Block
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Explained in the paper: https://paperswithcode.com/paper/rtmdet-an-empirical-study-of-designing-real
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn <span style="color:#66d9ef">as</span> nn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PAFPN</span>(nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;PAFPN Block
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    A feature pyramid model first introduced in https://paperswithcode.com/method/pafpn
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    in_channels: Channel of C3, the layer with least channel. C4, C5 have *2, *4 channels respectively.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, in_channels, out_channels):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c5_reduce <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(in_channels<span style="color:#f92672">=</span>in_channels <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>, out_channels<span style="color:#f92672">=</span>out_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c4_reduce <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(in_channels<span style="color:#f92672">=</span>in_channels <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, out_channels<span style="color:#f92672">=</span>out_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c3_reduce <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(in_channels<span style="color:#f92672">=</span>in_channels, out_channels<span style="color:#f92672">=</span>out_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c4_csp_up <span style="color:#f92672">=</span> RTMDetCSPBlock(in_channels<span style="color:#f92672">=</span>out_channels <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, out_channels<span style="color:#f92672">=</span>out_channels, downsample<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c3_csp_up <span style="color:#f92672">=</span> RTMDetCSPBlock(in_channels<span style="color:#f92672">=</span>out_channels <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, out_channels<span style="color:#f92672">=</span>out_channels, downsample<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c3_csp_down <span style="color:#f92672">=</span> RTMDetCSPBlock(in_channels<span style="color:#f92672">=</span>out_channels, out_channels<span style="color:#f92672">=</span>out_channels, downsample<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c4_csp_down <span style="color:#f92672">=</span> RTMDetCSPBlock(in_channels<span style="color:#f92672">=</span>out_channels <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, out_channels<span style="color:#f92672">=</span>out_channels, downsample<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c3_out <span style="color:#f92672">=</span> RTMDetCSPBlock(in_channels<span style="color:#f92672">=</span>out_channels, out_channels<span style="color:#f92672">=</span>out_channels, downsample<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c4_out <span style="color:#f92672">=</span> RTMDetCSPBlock(in_channels<span style="color:#f92672">=</span>out_channels <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, out_channels<span style="color:#f92672">=</span>out_channels, downsample<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>c5_out <span style="color:#f92672">=</span> RTMDetCSPBlock(in_channels<span style="color:#f92672">=</span>out_channels <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, out_channels<span style="color:#f92672">=</span>out_channels, downsample<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, c3, c4, c5):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Receives 3 feature maps from the CSPBackbone
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Input: 3 feature maps
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            c3, c4, c5 all in image format (B, C, H, W)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Output: 3 feature maps
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            c3_concat, c4_concat, c5_concat all in image format (B, C, H, W)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        p5 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c5_reduce(c5)
</span></span><span style="display:flex;"><span>        p4 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c4_reduce(c4)
</span></span><span style="display:flex;"><span>        p3 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c3_reduce(c3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 1. Downward concatenation</span>
</span></span><span style="display:flex;"><span>        p5_up <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>interpolate(p5, size<span style="color:#f92672">=</span>p4<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">2</span>:], mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bilinear&#39;</span>)
</span></span><span style="display:flex;"><span>        p4_plus <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([p5_up, p4], dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        p4_up <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c4_csp_up(p4_plus)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        p4_up_up <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>interpolate(p4_up, size<span style="color:#f92672">=</span>p3<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">2</span>:], mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bilinear&#39;</span>)
</span></span><span style="display:flex;"><span>        p3_plus <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([p4_up_up, p3], dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        p3_out_temp <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c3_csp_up(p3_plus)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 2. Upward concatenation</span>
</span></span><span style="display:flex;"><span>        p3_down <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c3_csp_down(p3_out_temp)
</span></span><span style="display:flex;"><span>        p4_plus_2 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([p3_down, p4_up], dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        p4_out_temp <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c4_csp_down(p4_plus_2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        p5_plus <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([p4_out_temp, p5], dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        p3_out <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c3_out(p3_out_temp)
</span></span><span style="display:flex;"><span>        p4_out <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c4_out(p4_plus_2)
</span></span><span style="display:flex;"><span>        p5_out <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>c5_out(p5_plus)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> p3_out, p4_out, p5_out
</span></span></code></pre></div><h1 id="3-detection-head">3. Detection Head</h1>
<p><img src="./rtmdet4.png" alt="head"></p>
<p>Detection head doesn&rsquo;t have a clear explanation also, so we&rsquo;ll have to make some assumptions.</p>
<ol>
<li>
<p><strong>labels are calculated separately for P3, P4, P5</strong></p>
<ul>
<li>P3 is usually 8 stride(grid 8x8), P4 is 16, and P5 is 32</li>
<li>Making predictions on all three pyramids make <strong>model more flexible to object size, being able to detect objects that are better detected on different grid sizes</strong></li>
</ul>
</li>
<li>
<p><strong>Translating (88, 72, 9) kernel shape to kernel</strong></p>
</li>
</ol>
<ul>
<li>Kernel mask has a total of 10 channels</li>
<li>1x1 Conv Layer with bias, for 8 output layers makes <code>(1 * 10 + 1) * 8 = 88</code>.</li>
<li>3x3 Conv Layer without bias, for 1 output layer makes <code>(9 * 8) * 1 = 72</code></li>
<li>3x3 Conv Layer without bias, for 1 output layer makes <code>(9) * 1 = 9</code></li>
</ul>
<p>To sum it up, the instance mask will have the following structure:</p>
<p><img src="./rtmdet5.png" alt="instance mask"></p>
<p>The mask calculation will be done as a postprocess after the detection head, since it is done only for valid prediction objects after the confidence threshold and nms algorithms.
so <strong>the role of the head will be to create the building blocks for generating the actual prediction:</strong></p>
<ol>
<li>The classification output: which will output the probability of having a bounding box of each class at each grid</li>
<li>The bounding box regression output: which will output the expected bounding box in the form of (offset_of_bbox_center_x_from_grid, offset_of_bbox_center_y_from_grid, width, height)</li>
<li>Mask kernel(169 channel convolution output) and Mask feature(8 features + 2 coordinate channels = 10 channels)</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Implements RTMDet Head for object detection and instance segmentation
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Based on Paper: https://arxiv.org/pdf/2212.07784v2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn <span style="color:#66d9ef">as</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RTMDetHead</span>(nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;RTMDet Head for object detection and instance segmentation
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Contains:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    1. Classification Head
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    2. Regression Head
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    3. Mask Head (for instance segmentation)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MASK_FEATURES <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    MASK_KERNEL_FEATURES <span style="color:#f92672">=</span> <span style="color:#ae81ff">169</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self,
</span></span><span style="display:flex;"><span>                 in_channels,
</span></span><span style="display:flex;"><span>                 feat_channels<span style="color:#f92672">=</span><span style="color:#ae81ff">256</span>,
</span></span><span style="display:flex;"><span>                 num_classes<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>,
</span></span><span style="display:flex;"><span>                 stacked_convs<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>                 ):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>in_channels <span style="color:#f92672">=</span> in_channels
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>feat_channels <span style="color:#f92672">=</span> feat_channels
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_classes <span style="color:#f92672">=</span> num_classes
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>stacked_convs <span style="color:#f92672">=</span> stacked_convs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Classification Head</span>
</span></span><span style="display:flex;"><span>        cls_convs <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>stacked_convs):
</span></span><span style="display:flex;"><span>            chn <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>in_channels <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> self<span style="color:#f92672">.</span>feat_channels
</span></span><span style="display:flex;"><span>            cls_convs<span style="color:#f92672">.</span>append(
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>Conv2d(chn, self<span style="color:#f92672">.</span>feat_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>            cls_convs<span style="color:#f92672">.</span>append(nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>feat_channels))
</span></span><span style="display:flex;"><span>            cls_convs<span style="color:#f92672">.</span>append(nn<span style="color:#f92672">.</span>SiLU(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cls_convs <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(<span style="color:#f92672">*</span>cls_convs)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cls_out <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>feat_channels, self<span style="color:#f92672">.</span>num_classes, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Regression Head</span>
</span></span><span style="display:flex;"><span>        reg_convs <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>stacked_convs):
</span></span><span style="display:flex;"><span>            chn <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>in_channels <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> self<span style="color:#f92672">.</span>feat_channels
</span></span><span style="display:flex;"><span>            reg_convs<span style="color:#f92672">.</span>append(
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>Conv2d(chn, self<span style="color:#f92672">.</span>feat_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>            reg_convs<span style="color:#f92672">.</span>append(nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>feat_channels))
</span></span><span style="display:flex;"><span>            reg_convs<span style="color:#f92672">.</span>append(nn<span style="color:#f92672">.</span>SiLU(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reg_convs <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(<span style="color:#f92672">*</span>reg_convs)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reg_out <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>feat_channels, <span style="color:#ae81ff">4</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mask Head</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>mask_kernel_convs <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>in_channels, self<span style="color:#f92672">.</span>feat_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>feat_channels),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>SiLU(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>feat_channels, self<span style="color:#f92672">.</span>feat_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>feat_channels),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>SiLU(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>feat_channels, self<span style="color:#f92672">.</span>MASK_KERNEL_FEATURES, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>mask_feat_convs <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>in_channels, self<span style="color:#f92672">.</span>feat_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>feat_channels),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>SiLU(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>feat_channels, self<span style="color:#f92672">.</span>feat_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>feat_channels),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>SiLU(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>feat_channels, self<span style="color:#f92672">.</span>feat_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>feat_channels),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>SiLU(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>feat_channels, self<span style="color:#f92672">.</span>feat_channels, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>BatchNorm2d(self<span style="color:#f92672">.</span>feat_channels),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>SiLU(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>Conv2d(self<span style="color:#f92672">.</span>feat_channels, self<span style="color:#f92672">.</span>MASK_FEATURES, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_forward_single_level</span>(self, x):
</span></span><span style="display:flex;"><span>        cls_feat <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cls_convs(x)
</span></span><span style="display:flex;"><span>        cls_score <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cls_out(cls_feat)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        reg_feat <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>reg_convs(x)
</span></span><span style="display:flex;"><span>        bbox_pred <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>reg_out(reg_feat)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        mask_kernels <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>mask_kernel_convs(x)
</span></span><span style="display:flex;"><span>        mask_feats <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>mask_feat_convs(x)
</span></span><span style="display:flex;"><span>        mask_feats <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>concat([mask_feats, self<span style="color:#f92672">.</span>create_coord_features(x<span style="color:#f92672">.</span>size(<span style="color:#ae81ff">0</span>), x<span style="color:#f92672">.</span>size(<span style="color:#ae81ff">2</span>), x<span style="color:#f92672">.</span>size(<span style="color:#ae81ff">3</span>))], dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> mask_feats<span style="color:#f92672">.</span>size(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> self<span style="color:#f92672">.</span>MASK_FEATURES <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> mask_kernels<span style="color:#f92672">.</span>size(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> self<span style="color:#f92672">.</span>MASK_KERNEL_FEATURES
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> cls_score, bbox_pred, mask_kernels, mask_feats
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_coord_features</span>(n_batch, w, h):
</span></span><span style="display:flex;"><span>        x_range <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>linspace(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, w)
</span></span><span style="display:flex;"><span>        y_range <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>linspace(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, h)
</span></span><span style="display:flex;"><span>        y, x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>meshgrid(y_range, x_range, indexing<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ij&#39;</span>)
</span></span><span style="display:flex;"><span>        coord_features_batch <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>stack([x, y], dim<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>expand(n_batch, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> coord_features_batch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, feats):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Gets input from P3, P4, P5 and gives outputs needed for creating predictions.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            feats: P3, P4, P5 output from PAFPN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            cls_scores: has n_classes predictions for every P3/P4/P5 pixels
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            bbox_preds: has n_classes * 4 predictions for every P3/P4/P5 pixels, one bbox
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        prediction is of format (center_dx_from_grid, center_dy_from_grid, w, h)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            mask_kernels: (B, MASK_KERNEL_FEATURES, H, W)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            mask_feats: (B, MASK_FEATURES + 2, H, W)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        cls_scores <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        bbox_preds <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        mask_kernels_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        mask_feats_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> feat <span style="color:#f92672">in</span> feats:
</span></span><span style="display:flex;"><span>            cls_score, bbox_pred, mask_kernels, mask_feats <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_forward_single_level(feat)
</span></span><span style="display:flex;"><span>            mask_kernels_list<span style="color:#f92672">.</span>append(mask_kernels)
</span></span><span style="display:flex;"><span>            mask_feats_list<span style="color:#f92672">.</span>append(mask_feats)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            cls_scores<span style="color:#f92672">.</span>append(cls_score)
</span></span><span style="display:flex;"><span>            bbox_preds<span style="color:#f92672">.</span>append(bbox_pred)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> cls_scores, bbox_preds, mask_kernels_list, mask_feats_list
</span></span></code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>This implements all the backbone/neck/head building blocks of the model. There is still more to be done:</p>
<ol>
<li>Preprocess: Loading COCO format dataset as label, data augmentation</li>
<li>Translation: Translate label coordinates to grid/offset in P3/P4/P5 coordinates.</li>
<li>PostProcess: nms + confidence threshold to remove incompetent predictions, mapping predictions to ground truth, mask dynamic CNN logic</li>
<li>Debugging: Showing image with masks overlapped.</li>
</ol>
<p>All these will be handled in separate pages.</p>


        
      </section>

      

      
    </article>
  </div>

  <div class="hidden lg:flex lg:flex-col lg:items-end">
    
  </div>
</div>


            
<footer class="flex justify-between items-center gap-2 px-4 py-12">

  <div>
  
  <p>© 2025 Junyeop Na Dev</p>
  

  
  <p class="text-sm">
    🌱
    <span class="text-base-content/60">
      Powered by <a class="hover:underline" href="https://gohugo.io/" target="_blank">Hugo</a> with theme
      <a class="hover:underline" href="https://github.com/g1eny0ung/hugo-theme-dream" target="_blank">Dream</a>.</span
    >
  </p>
  
</div>

  <div
  x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }"
  class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"
>
  <template x-for="icon in icons">
    <div
      role="button"
      tabindex="0"
      :aria-label="'Select ' + icon.name + ' mode'"
      class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary"
      :class="$store.darkMode.icon() === icon.name && 'bg-primary'"
      @click="$store.darkMode.toggle(icon.status)"
    >
      <ion-icon
        :name="`${icon.name}-outline`"
        class="group-hover:text-primary-content"
        :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"
      >
      </ion-icon>
    </div>
  </template>
</div>

</footer>

          </div>
        </div>
        <div class="back">
          <div class="container">
            
            <div class="dream-grid dream-grid-about">
  

  

  
</div>

            

            
<footer class="flex justify-between items-center gap-2 px-4 py-12">

  <div>
  
  <p>© 2025 Junyeop Na Dev</p>
  

  
  <p class="text-sm">
    🌱
    <span class="text-base-content/60">
      Powered by <a class="hover:underline" href="https://gohugo.io/" target="_blank">Hugo</a> with theme
      <a class="hover:underline" href="https://github.com/g1eny0ung/hugo-theme-dream" target="_blank">Dream</a>.</span
    >
  </p>
  
</div>

  <div
  x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }"
  class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"
>
  <template x-for="icon in icons">
    <div
      role="button"
      tabindex="0"
      :aria-label="'Select ' + icon.name + ' mode'"
      class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary"
      :class="$store.darkMode.icon() === icon.name && 'bg-primary'"
      @click="$store.darkMode.toggle(icon.status)"
    >
      <ion-icon
        :name="`${icon.name}-outline`"
        class="group-hover:text-primary-content"
        :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"
      >
      </ion-icon>
    </div>
  </template>
</div>

</footer>

          </div>
        </div>
      </div>
    </div>

    <script>
  window.lightTheme =  null 
  window.darkTheme =  null 
</script>


  <script src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>

  
  
    
  
  <script src="/js/grid.min.js"></script>




  

<script src="/js/main.min.js"></script>

    









    

    

    

    

    <script type="module" src="https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js"></script>
  </body>
</html>
